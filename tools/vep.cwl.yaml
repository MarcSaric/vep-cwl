#!/usr/bin/env cwl-runner

description: |
    description: "Running Variant Effect Predictor v84"
    Usage:  cwl-runner <this-file-path> options

requirements:
  - import: node-engine.cwl
  - class: ShellCommandRequirement
  - class: InlineJavascriptRequirement
  - class: DockerRequirement
    dockerPull: quay.io/ncigdc/vep-tool:latest 

class: CommandLineTool

inputs:
  - id: "#input_file"
    type: File
    label: "Input File"
    description: "path to file you wish to annotate"
    inputBinding:
        prefix: --input_file

  - id: "#fasta"
    type: File
    label: "Reference fasta"
    description: "path to reference file"
    inputBinding:
        prefix: --fasta
        secondaryFiles:
            - ".fai"
            - ".gzi"

  - id: "#dir_cache"
    type: File 
    label: "Cache directory" 
    description: "specific directory for cache" 
    inputBinding:
        prefix: --dir_cache

  - id: "#dir_plugins"
    type: File
    default: null
    label: "specific directory for plugins" 
    description: "path to reference file"
    inputBinding:
        prefix: --dir_plugins

  - id: "#output_file"
    type: string 
    label: "Output file" 
    description: "output file name" 
    inputBinding:
        prefix: --output_file

  - id: "#stats_file"
    type: string 
    label: "Statistics file" 
    description: "the path to the output stats file (HTML is default type)" 
    default: null
    inputBinding:
        prefix: --stats_file

  - id: "#no_stats"
    type: ["null", boolean]
    label: "No Stats" 
    description: "if you don't want stats to be output" 
    inputBinding:
        prefix: --no_stats

  - id: "#warning_file"
    type: string 
    label: "Plugin directory" 
    description: "file to write warnings to" 
    default: null
    inputBinding:
        prefix: --warning_file

  - id: "#stats_text"
    type: boolean
    default: null
    label: "Stats text" 
    description: "output stats file as text instead of HTML" 
    inputBinding:
        prefix: --stats_text

  - id: "#format"
    type: string
    default: "vcf"
    label: "Input file format" 
    description: "input file format" 
    inputBinding:
        prefix: --format
        
  - id: "#individual"
    type: string
    default: null
    label: "Individual" 
    description: "only output variants from this individual in the vcf file" 
    inputBinding:
        prefix: --individual

  - id: "#tabix"
    type: boolean
    default: null
    label: "Tabix flag" 
    description: "bgzip and tabix-index output" 
    inputBinding:
        prefix: --tabix

  - id: "#gvf"
    type: boolean
    default: null
    label: "Output gvf" 
    description: "produce gvf output" 
    inputBinding:
        prefix: --gvf

  - id: "#vcf"
    type: boolean
    default: null
    label: "Output vcf" 
    description: "produce VCF output" 
    inputBinding:
        prefix: --vcf

  - id: "#solr"
    type: boolean
    default: null
    label: "Output solr" 
    description: "produce XML output for Solr" 
    inputBinding:
        prefix: --solr

  - id: "#json"
    type: boolean
    default: null
    label: "Output JSON" 
    description: "produce JSON document output" 
    inputBinding:
        prefix: --json

  - id: "#tab"
    type: boolean
    default: null
    label: "Output tab-delimited" 
    description: "produce tabulated output" 
    inputBinding:
        prefix: --tab

  - id: "#vcf_info_field"
    type: string
    default: null 
    label: "VCF info field" 
    description: "allow user to change VCF info field name" 
    inputBinding:
        prefix: --vcf_info_field

  - id: "#keep_csq"
    type: boolean
    default: null
    label: "Keep CSQ" 
    description: "don't nuke existing CSQ fields in VCF" 
    inputBinding:
        prefix: --keep_csq

  - id: "#keep_ann"
    type: boolean
    default: null
    label: "Keep ann" 
    description: "synonym for keep_seq" 
    inputBinding:
        prefix: --keep_ann

  - id: "#assembly"
    type: string
    default: "GRCh38"
    label: "Assembly" 
    description: "assembly version to use" 
    inputBinding:
        prefix: --assembly

  - id: "#chr"
    type: string
    default: null 
    label: "Chromosomes" 
    description: "analyze only these chromosomes, e.g., 1-5,10,MT" 
    inputBinding:
        prefix: --chr

  - id: "#check_ref"
    type: boolean
    default: null
    label: "Check reference" 
    description: "check supplied reference allele against DB" 
    inputBinding:
        prefix: --check_ref

  - id: "#check_existing"
    type: boolean
    default: null
    label: "Check exisiting" 
    description: "find existing co-located variations" 
    inputBinding:
        prefix: --check_existing

  - id: "#check_svs"
    type: boolean
    default: null
    label: "Check SVS" 
    description: "find overlapping structural variations" 
    inputBinding:
        prefix: --check_svs

  - id: "#check_alleles"
    type: boolean
    default: null
    label: "Check alleles" 
    description: "only attribute co-located if alleles are the same" 
    inputBinding:
        prefix: --check_alleles

  - id: "#check_frequency"
    type: boolean
    default: null
    label: "Check frequency" 
    description: "enable frequency checking" 
    inputBinding:
        prefix: --check_frequency

  - id: "#gmaf"
    type: boolean
    default: null
    label: "Global MAF" 
    description: "add global MAF of existing var" 
    inputBinding:
        prefix: --gmaf

  - id: "#maf_1kg"
    type: boolean
    default: null
    label: "MAF 1000 Genomes" 
    description: "add 1KG MAFs of existing vars" 
    inputBinding:
        prefix: --maf_1kg

  - id: "#maf_esp"
    type: boolean
    default: null
    label: "MAF ESP" 
    description: "add ESP MAFs of existing vars" 
    inputBinding:
        prefix: --maf_esp

  - id: "#maf_exac"
    type: boolean
    default: null
    label: "MAF ExAC" 
    description: "add ExAC MAFs of existing vars" 
    inputBinding:
        prefix: --maf_exac

  - id: "#phased"
    type: boolean
    default: null
    label: "Phased" 
    description: "force VCF genotypes to be interpreted as phased" 
    inputBinding:
        prefix: --phased

  - id: "#fork"
    type: int 
    default: 1 
    label: "Fork" 
    description: "fork into N processes" 
    inputBinding:
        prefix: --fork

  - id: "#dont_skip"
    type: boolean
    default: null
    label: "Don't skip" 
    description: "don't skip vars that fail validation" 
    inputBinding:
        prefix: --dont_skip

  - id: "#verbose"
    type: boolean
    default: null
    label: "Verbose" 
    description: "print out a bit more info while running" 
    inputBinding:
        prefix: --verbose

  - id: "#quiet"
    type: boolean
    default: null
    label: "Quiet" 
    description: "print nothign to STDOUT (unless using -o stdout)" 
    inputBinding:
        prefix: --quiet

  - id: "#no_progress"
    type: boolean
    default: null
    label: "No progress bar" 
    description: "don't display progress bars" 
    inputBinding:
        prefix: --no_progress

  - id: "#everything"
    type: boolean
    default: null
    label: "Everything" 
    description: "switch on EVERYTHING" 
    inputBinding:
        prefix: --everything

  - id: "#canonical"
    type: boolean
    default: null
    label: "Canonical" 
    description: "indicates if transcript is canonical" 
    inputBinding:
        prefix: --canonical

  - id: "#tsl"
    type: boolean
    default: null
    label: "TSL" 
    description: "output transcript support level" 
    inputBinding:
        prefix: --tsl

  - id: "#appris"
    type: boolean
    default: null
    label: "APPRIS" 
    description: "output APPRIS transcript annotation" 
    inputBinding:
        prefix: --appris

  - id: "#ccds"
    type: boolean
    default: null
    label: "CCDS" 
    description: "output CCDS identifier" 
    inputBinding:
        prefix: --ccds

  - id: "#xref_refseq"
    type: boolean
    default: null
    label: "XREF RefSeq" 
    description: "output refseq mrna xref" 
    inputBinding:
        prefix: --xref_refseq

  - id: "#uniprot"
    type: boolean
    default: null
    label: "UniProt" 
    description: "output Uniprot identifiers (includes UniParc)" 
    inputBinding:
        prefix: --uniprot

  - id: "#protein"
    type: boolean
    default: null
    label: "Protein" 
    description: "add e! protein ID to extra column" 
    inputBinding:
        prefix: --protein

  - id: "#biotype"
    type: boolean
    default: null
    label: "Biotype" 
    description: "add biotype of transcript to output" 
    inputBinding:
        prefix: --biotype

  - id: "#hgnc"
    type: boolean
    default: null
    label: "HGNC ID" 
    description: "add HGNC gene ID to extra column" 
    inputBinding:
        prefix: --hgnc

  - id: "#symbol"
    type: boolean
    default: null
    label: "Gene Symbol" 
    description: "add gene symbol (e.g., HGNC)" 
    inputBinding:
        prefix: --symbol

  - id: "#gene_phenotype"
    type: boolean
    default: null
    label: "Gene phenotype" 
    description: "indicates if genes are phenotype-associated" 
    inputBinding:
        prefix: --gene_phenotype

  - id: "#hgvs"
    type: boolean
    default: null
    label: "HGVS" 
    description: "add HGVS names to extra column" 
    inputBinding:
        prefix: --hgvs

  - id: "#shift_hgvs"
    type: int 
    default: null
    label: "Shift HGVS" 
    description: "disable/enable 3-prime shifting of HGVS indels to comply with standard" 
    inputBinding:
        prefix: --shift_hgvs

  - id: "#sift"
    type: string
    default: null 
    label: "SIFT" 
    description: "SIFT predictions" 
    inputBinding:
        prefix: --sift

  - id: "#polyphen"
    type: string
    default: null 
    label: "PolyPhen" 
    description: "PolyPhen predictions" 
    inputBinding:
        prefix: --polyphen

  - id: "#humdiv"
    type: boolean
    default: null
    label: "humdiv" 
    description: "use humDiv instead of humVar for PolyPhen" 
    inputBinding:
        prefix: --humdiv

  - id: "#condel"
    type: boolean
    default: null
    label: "Condel" 
    description: "Condel predictions" 
    inputBinding:
        prefix: --condel

  - id: "#variant_class"
    type: boolean
    default: null
    label: "Variant class" 
    description: "get SO variant type" 
    inputBinding:
        prefix: --variant_class

  - id: "#regulatory"
    type: boolean
    default: null
    label: "Regulatory" 
    description: "enable regulatory stuff" 
    inputBinding:
        prefix: --regulatory

  - id: "#no_intergenic"
    type: boolean
    default: null
    label: "No intergenic" 
    description: "don't print out INTEGENIC consequences" 
    inputBinding:
        prefix: --no_intergenic

  - id: "#domains"
    type: boolean
    default: null
    label: "Domains" 
    description: "output overlapping protein features" 
    inputBinding:
        prefix: --domains

  - id: "#numbers"
    type: boolean
    default: null
    label: "Numbers" 
    description: "include exon and intron numbers" 
    inputBinding:
        prefix: --numbers

  - id: "#total_length"
    type: boolean
    default: null
    label: "Total length" 
    description: "give total length alongside positions e.g., 14/203" 
    inputBinding:
        prefix: --total_length

  - id: "#allele_number"
    type: boolean
    default: null
    label: "Allele number" 
    description: "indicate allele by number to avoid confusion with VCF conversions" 
    inputBinding:
        prefix: --allele_number

  - id: "#no_escape"
    type: boolean
    default: null
    label: "No escape" 
    description: "don't percent-escape HGVS strings" 
    inputBinding:
        prefix: --no_escape

  - id: "#cache_version"
    type: string
    default: "84"
    label: "Cache version" 
    description: "specify a different cache version" 
    inputBinding:
        prefix: --cache_version

  - id: "#plugin"
    type: 
      - "null"
      - type: array
        items: string
        inputBinding: { prefix: "--plugin" }
    label: "Plugin options" 
    description: "specify a method in a module in the plugins directory. use multiple times if needed" 

  - id: "#gdc_entrez"
    type: File
    default: null
    description: "if you want to use the GDC_entrez plugin, the path to the json file"
    inputBinding:
        prefix: "--plugin"
        valueFrom: "$(self ? 'GDC_entrez,' + self.path : null)"

  - id: "#gdc_evidence"
    type: File
    default: null
    description: "if you want to use the GDC_evidence plugin, the path to the tabix-indexed variation vcf"
    inputBinding:
        prefix: "--plugin"
        valueFrom: "$(self ? 'GDC_evidence,' + self.path : null)"
        secondaryFiles:
            - ".tbi"

  - id: "#fields"
    type: string
    default: null
    label: "Fields" 
    description: "Configure the output format using a comma separated list of fields. Fields may be those present in the default output columns, or any of those that appear in the Extra column (including those added by plugins or custom annotations)."
    inputBinding:
        prefix: --fields

outputs:
  - id: "#vep_out"
    type: File
    description: "annotated output file"
    outputBinding:
        glob: $(inputs['output_file'])

  - id: "#stats_file"
    type: [File, "null"]
    description: "statistics file"
    outputBinding:
        glob: $(inputs['stats_file'])

  - id: "#warning_file"
    type: ["null", File]
    description: "warnings file"
    outputBinding:
        glob: $(inputs['warning_file'])

  - id: "#log_file"
    type: File
    description: "stdout file"
    outputBinding:
        glob: $(inputs['output_file'] + '.vep.logs')

  - id: "#time_file"
    type: File
    description: "time file"
    outputBinding:
        glob: $(inputs['output_file'] + '.vep.time')

baseCommand: ["/usr/bin/time", "-v"]

arguments:
  - valueFrom: $(inputs['output_file'] + '.vep.time')
    position: -99
    prefix: "-o"

  - valueFrom: "variant_effect_predictor.pl"
    position: -98

  - valueFrom: "--offline"
    position: -97

  - valueFrom: "--cache"
    position: -96

  - valueFrom: "--force_overwrite"
    position: -95

  - valueFrom: $(inputs['output_file'] + '.vep.logs')
    position: 99 
    prefix: ">"

  - valueFrom: '2>&1'
    position: 100 
    shellQuote: false 
