#!/usr/bin/env cwl-runner

class: Workflow

requirements:
  - class: InlineJavascriptRequirement 
  - class: StepInputExpressionRequirement

inputs:
  - id: "#postgres_config"
    type: File
    description: "postgres config file"
  - id: "#host"
    type: string 
    description: "postgres host name"
  - id: "#run_hostname"
    type: string 
    default: "UNKNOWN"
    description: "running environment hostname"
  - id: "#input_vcf"
    type: File
    description: "The vcf file you want to annotate"
  - id: "#vcf_id"
    type: string
    description: "The VCF ID for output files."
  - id: "#src_vcf_id"
    type: string
    description: "The input (source) VCF ID."
  - id: "#case_id"
    type: string
    default: null
    description: "The case ID."
  - id: "#patient_barcode"
    type: string
    default: null
    description: "The patient barcode."
  - id: "#tumor_barcode"
    type: string
    default: null
    description: "The tumor sample barcode."
  - id: "#tumor_aliquot_uuid"
    type: string
    default: null
    description: "The tumor sample barcode."
  - id: "#tumor_bam_uuid"
    type: string
    default: null
    description: "The tumor BAM unique ID."
  - id: "#normal_barcode"
    type: string
    default: null
    description: "The normal sample barcode."
  - id: "#normal_aliquot_uuid"
    type: string
    default: null
    description: "The normal sample barcode."
  - id: "#normal_bam_uuid"
    type: string
    default: null
    description: "The normal BAM unique ID."
  - id: "#caller_workflow_id"
    type: string
    description: "caller workflow ID"
  - id: "#caller_workflow_name"
    type: string
    description: "caller workflow Name"
  - id: "#caller_workflow_description"
    type: string
    default: null
    description: "caller workflow Description"
  - id: "#caller_workflow_version"
    type: string
    default: null
    description: "caller workflow Version"
  - id: "#annotation_workflow_id"
    type: string
    description: "annotation workflow ID"
  - id: "#annotation_workflow_name"
    type: string
    description: "annotation workflow Name"
  - id: "#annotation_workflow_description"
    type: string
    default: null
    description: "annotation workflow Description"
  - id: "#annotation_workflow_version"
    type: string
    default: null
    description: "annotation workflow Version"
  - id: "#ref"
    type: File
    description: "path to tabix indexed and faidx indexed fasta file"
  - id: "#dir_cache"
    type: File 
    description: "path to the cache directory"
  - id: "#gdc_entrez"
    type: File 
    description: "path to the json file for the GDC_entrez plugin"
  - id: "#gdc_evidence"
    type: File 
    description: "path to the vcf file for the GDC_evidence plugin"
  - id: "#vcf"
    type: boolean
    default: null
    description: "output VCF format"
  - id: "#json"
    type: boolean
    default: null
    description: "output JSON format"
  - id: "#tab"
    type: boolean
    default: null
    description: "output TAB format"
  - id: "#stats_file"
    type: boolean
    default: null
    description: "if you want to also output the VEP stats file"
  - id: "#fork"
    type: int
    default: 1
    description: "vep threads"
  - id: "#fields"
    type: string
    default: null
    description: "configure the output format using a comma separated list of fields. Fields may be those present in the default output columns, or any of those that appear in the Extra column (including those added by plugins or custom annotations)."

outputs:
  - id: "contig_filter_log_file"
    type: File
    source: "#contig-filter.log_file"
  - id: "vep_stats"
    type: File
    source: "#vep.stats_file"
  - id: "vep_log_file"
    type: File
    source: "#vep.log_file"
  - id: "vcf-reheader_vcf"
    type: File
    source: "#vcf-reheader.vcf_out"
  - id: "vcf-reheader_log_file"
    type: File
    source: "#vcf-reheader.log_file"

steps:
  - id: "#contig-filter"
    run: {import: ../tools/contigfilter.cwl.yaml}
    inputs:
      - {id: "#contig-filter.input_vcf", source: "#input_vcf"}
      - {id: "#contig-filter.output_vcf", source: "#vcf_id", valueFrom: "$(self + '.contig_filter.vcf')"}
    outputs:
      - id: "#contig-filter.vcf_out"
      - id: "#contig-filter.log_file"
      - id: "#contig-filter.time_file"
  - id: "#vep"
    run: {import: ../tools/vep.cwl.yaml}
    inputs:
      - {id: "#vep.input_file", source: "#contig-filter.vcf_out"}
      - {id: "#vep.fasta", source: "#ref"}
      - {id: "#vep.dir_cache", source: "#dir_cache"}
      - id: "#vep.output_file"
        source: ["#vcf_id", "#vcf", "#json", "#tab"]
        valueFrom: "$(self[1] ? self[0] + '.vep.vcf': self[2] ? self[0] + '.vep.json': self[0] + '.vep.tsv')"
      - {id: "#vep.vcf", source: "#vcf"}
      - {id: "#vep.json", source: "#json"}
      - {id: "#vep.tab", source: "#tab"}
      - {id: "#vep.stats_file", source: ["#stats_file", "#vcf_id"], valueFrom: "$(self[0] ? self[1] + '.vep.stats.txt' : null)" }
      - {id: "#vep.stats_text", source: "#stats_file" } 
      - {id: "#vep.no_stats", source: "#stats_file", valueFrom: "$(self ? null : true)"}
      - {id: "#vep.fork", source: "#fork"}
      - {id: "#vep.no_progress", valueFrom: "$(true)"} 
      - {id: "#vep.everything", valueFrom: "$(true)"}
      - {id: "#vep.xref_refseq", valueFrom: "$(true)"}
      - {id: "#vep.total_length", valueFrom: "$(true)"}
      - {id: "#vep.allele_number", valueFrom: "$(true)"}
      - {id: "#vep.check_alleles", valueFrom: "$(true)"}
      - {id: "#vep.assembly", valueFrom: "$('GRCh38')"}
      - {id: "#vep.gdc_entrez", source: "#gdc_entrez"} 
      - {id: "#vep.gdc_evidence", source: "#gdc_evidence"}
    outputs:
      - id: "#vep.vep_out"
      - id: "#vep.stats_file"
      - id: "#vep.warning_file"
      - id: "#vep.log_file"
      - id: "#vep.time_file"
  - id: "#vcf-reheader"
    run: {import: ../tools/vcfreheader.cwl.yaml}
    inputs:
      - {id: "#vcf-reheader.input_vcf", source: "#vep.vep_out"}
      - {id: "#vcf-reheader.output_vcf", source: "#vcf_id", valueFrom: "$(self + '.vep.reheader.vcf.gz')"}
      - {id: "#vcf-reheader.patient_barcode", source: "#patient_barcode"}
      - {id: "#vcf-reheader.case_id", source: "#case_id"}
      - {id: "#vcf-reheader.tumor_barcode", source: "#tumor_barcode"}
      - {id: "#vcf-reheader.tumor_aliquot_uuid", source: "#tumor_aliquot_uuid"}
      - {id: "#vcf-reheader.tumor_bam_uuid", source: "#tumor_bam_uuid"}
      - {id: "#vcf-reheader.normal_barcode", source: "#normal_barcode"}
      - {id: "#vcf-reheader.normal_aliquot_uuid", source: "#normal_aliquot_uuid"}
      - {id: "#vcf-reheader.normal_bam_uuid", source: "#normal_bam_uuid"}
      - {id: "#vcf-reheader.caller_workflow_id", source: "#caller_workflow_id"}
      - {id: "#vcf-reheader.caller_workflow_name", source: "#caller_workflow_name"}
      - {id: "#vcf-reheader.caller_workflow_description", source: "#caller_workflow_description"}
      - {id: "#vcf-reheader.caller_workflow_version", source: "#caller_workflow_version"}
      - {id: "#vcf-reheader.annotation_workflow_id", source: "#annotation_workflow_id"}
      - {id: "#vcf-reheader.annotation_workflow_name", source: "#annotation_workflow_name"}
      - {id: "#vcf-reheader.annotation_workflow_description", source: "#annotation_workflow_description"}
      - {id: "#vcf-reheader.annotation_workflow_version", source: "#annotation_workflow_version"}
    outputs:
      - id: "#vcf-reheader.vcf_out"
      - id: "#vcf-reheader.log_file"
      - id: "#vcf-reheader.time_file"
  - id: "#vep-pg"
    run: {import: ../tools/pg_metrics.cwl.yaml}
    inputs:
      - {id: "#vep-pg.tool", default: "vep"}
      - {id: "#vep-pg.time_file", source: "#vep.time_file"}
      - {id: "#vep-pg.normal_id", source: "#normal_bam_uuid"}
      - {id: "#vep-pg.tumor_id", source: "#tumor_bam_uuid"}
      - {id: "#vep-pg.input_uuid", source: "#src_vcf_id"}
      - {id: "#vep-pg.output_uuid", source: "#vcf_id"}
      - {id: "#vep-pg.case_id", source: "#case_id"}
      - {id: "#vep-pg.postgres_config", source: "#postgres_config"}
      - {id: "#vep-pg.host", source: "#host"}
      - {id: "#vep-pg.input_file", source: "#vcf-reheader.vcf_out"}
      - {id: "#vep-pg.stats_file", source: "#vep.stats_file"}
      - {id: "#vep-pg.hostname", source: "#run_hostname"}
    outputs: []
